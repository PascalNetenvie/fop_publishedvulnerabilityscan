<?php
/**
 * Friends Of Presta Published Vulnerability Scan
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file docs/licenses/LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * https://opensource.org/licenses/afl-3.0.php
 *
 * @author    Experto PrestaShop <https://www.youtube.com/@ExpertoPrestaShop>
 * @copyright since 2009 Experto PrestaShop
 * @license   https://opensource.org/licenses/AFL-3.0  Academic Free License ("AFL") v. 3.0
 */

if (!defined('_PS_VERSION_')) {
    exit;
}

require dirname(__FILE__) . '/vendor/autoload.php';

class Fop_PublishedVulnerabilityScan extends Module
{
    public function __construct()
    {
        $this->name = 'fop_publishedvulnerabilityscan';
        $this->tab = 'administration';
        $this->version = '1.0.0';
        $this->author = 'Experto PrestaShop';
        $this->need_instance = 1;
        $this->bootstrap = true;
        $this->multishop_context = Shop::CONTEXT_ALL;

        parent::__construct();

        $this->displayName = $this->l('Friends Of Presta Published Vulnerability Scan');
        $this->description = $this->l('Scans your shop searching for any vulnerability published on the FOP security advisories list.');

        $this->ps_versions_compliancy = ['min' => '1.6', 'max' => _PS_VERSION_];
    }

    public function install()
    {
        $hooks = [];
        if (version_compare(_PS_VERSION_, '1.7', '>=')) {
            $hooks[] = 'actionAdminControllerSetMedia';
        } else {
            $hooks[] = 'displayBackOfficeHeader';
        }

        return parent::install() && $this->registerHook($hooks);
    }

    public function getContent()
    {
        $output = '';
        $file_path_security_list = $this->local_path . 'downloads/security_list_feed.xml';
        $file_path_modules_check_list = $this->local_path . 'downloads/modules_check_list.json';

        if (!file_exists($file_path_security_list)
            || Configuration::get('FOPPVS_LAST_LIST_DOWNLOAD') < strtotime('-24 hour')
        ) {
            if (Tools::copy('https://security.friendsofpresta.org/feed.xml', $file_path_security_list)) {
                Configuration::updateValue('FOPPVS_LAST_LIST_DOWNLOAD', time());
            } else {
                $output .= $this->displayError($this->l('Security list file cannot be downloaded.') . ' ' . $this->l('Try again later.'));
            }
        }

        if (file_exists($file_path_security_list)) {
            if (!$xml = @simplexml_load_file($file_path_security_list)) {
                @unlink($file_path_security_list);
                $output .= $this->displayError($this->l('Security list data cannot be processed.') . ' ' . $this->l('Try again later.'));
            } elseif (!file_exists($file_path_modules_check_list)
                || Configuration::get('FOPPVS_LAST_LIST_PROCESSED') < strtotime($xml->updated)
            ) {
                if ($modules_check_list = FopPvsTools::processModulesCheckList($xml)) {
                    Configuration::updateValue('FOPPVS_LAST_LIST_PROCESSED', strtotime($xml->updated));
                    file_put_contents($file_path_modules_check_list, json_encode($modules_check_list));

                    $output .= $this->displayConfirmation($this->l('New modules security list data processed.'));
                } else {
                    @unlink($file_path_modules_check_list);
                    $output .= $this->displayError($this->l('Modules security list data cannot be processed.') . ' ' . $this->l('Try again later.'));
                }
            }
        }

        if (!file_exists($file_path_modules_check_list)) {
            $output .= $this->displayError($this->l('Security list data cannot be processed.') . ' ' . $this->l('Try again later.'));
        }

        return $output . $this->renderForm();
    }

    public function renderForm()
    {
        $modules_issues = [];
        $file_path_modules_check_list = $this->local_path . 'downloads/modules_check_list.json';
        if (file_exists($file_path_modules_check_list)
         && $json_modules_check_list = @json_decode(Tools::file_get_contents($file_path_modules_check_list))
        ) {
            $modules_issues = FopPvsTools::getModulesIssueList($json_modules_check_list);
        }
        $this->context->smarty->assign(['modules_issues' => $modules_issues]);

        $fields_form = [
            'form' => [
                'legend' => [
                    'title' => $this->l('Vulnerabilities'),
                    'icon' => 'icon-exclamation',
                ],
                'input' => [
                    [
                        'type' => 'html',
                        'html_content' => $this->context->smarty->fetch($this->local_path . 'views/templates/admin/modules_issues.tpl'),
                        'name' => 'VULNERABILITIES_FOUND',
                    ],
                ],
            ],
        ];

        $helper = new HelperForm();
        $helper->show_toolbar = false;
        $helper->table = $this->table;
        $helper->default_form_language = (int) Configuration::get('PS_LANG_DEFAULT');
        $helper->allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') ? Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') : 0;
        $helper->identifier = $this->identifier;
        $helper->currentIndex = $this->context->link->getAdminLink('AdminModules', false) .
            '&configure=' . $this->name .
            '&tab_module=' . $this->tab .
            '&module_name=' . $this->name;
        $helper->token = Tools::getAdminTokenLite('AdminModules');
        $helper->tpl_vars = [
            'fields_value' => [],
            'languages' => $this->context->controller->getLanguages(),
            'id_language' => $this->context->language->id,
        ];

        return $helper->generateForm([$fields_form]);
    }

    public function hookDisplayBackOfficeHeader()
    {
        return $this->hookActionAdminControllerSetMedia();
    }

    public function hookActionAdminControllerSetMedia()
    {
        $controller_name = $this->context->controller->controller_name;

        if ($controller_name == 'AdminModules' && Tools::getValue('configure') == $this->name) {
            $this->context->controller->addCSS($this->_path . 'views/css/module_config.css');
            $this->context->controller->addJS($this->_path . 'views/js/module_config.js');
        }
    }
}
